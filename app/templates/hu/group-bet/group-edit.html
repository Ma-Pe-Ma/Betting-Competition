{% extends language + "/layouts/base.html" %}

{% block title %} Csoportkör-tippek {% endblock %} 

<!-- Plugins CSS goes HERE  -->
{% block plugin_stylesheets %}{% endblock plugin_stylesheets %}

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}{% endblock stylesheets %}

{% block content %}

    <div class="container-fluid">
        <!-- ============================================================== -->
        <!-- Bread crumb and right sidebar toggle -->
        <!-- ============================================================== -->
        <div class="row page-titles">
            <div class="col-md-5 col-8 align-self-center">
                <h3 class="text-themecolor m-b-0 m-t-0">Csoportkör-fogadások</h3>
                <!--ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="javascript:void(0)">Home</a></li>
                    <li class="breadcrumb-item active">Dashboard</li>
                </ol-->
            </div>
            <!--div class="col-md-7 col-4 align-self-center">
                <a target="_blank"
                   href="https://appseed.us"
                    class="btn waves-effect waves-light btn-danger pull-right hidden-sm-down">
                    More Starters
                </a>
            </div-->
        </div>
        <!-- ============================================================== -->
        <!-- End Bread crumb and right sidebar toggle -->
        <!-- ============================================================== -->
        <!-- ============================================================== -->
        <!-- Start Page Content -->
        <!-- ============================================================== -->
        <script src="https://sortablejs.github.io/Sortable/Sortable.js"></script>

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-block">
                        <div>Kezdőtőke: {{start_amount}}</div>

                        <div>
                            <div style="display: inline-block;"> Végeredmény-tipp :</div>

                            <select name="teamSelect" id="teamSelect" style="display: inline-block;"> </select>
                            <select name="resultSelect" id="resultSelect" style="display: inline-block;"> </select>
                            <label for="finalResultOdd" style="padding-left: 1em;">Szorzó: </label>
                            <div id="finalResultOdd" style="display: inline-block;"></div>
                            <a href="./final-odds">(táblázatos forma)</a>

                            <label for="finalResultBet" style="padding-left: 1em;">Tét: </label>
                            <input id="finalResultBet" style="display: inline-block;" type="number" min="0" max="200" size="3" value="{{final_bet.betting_amount}}">

                            <label for="expectedWinAmount" style="padding-left: 1em;"> Várható nyeremény: </label>
                            <div style="display: inline-block;" id="expectedWinAmount"> </div>
                        </div>                        
                        
                        <div>Vonszolással állítsd be a csoportok sorrendjét!</div>
                        {% for group in groups %}
                            <div id="{{group.ID}}" class="row" style="width: 26em;">
                                <h4 class="col-12" style="display:inline;">{{group.ID}}. csoport</h4>

                                <div id="example4-left" class="list-group col" style="padding-left: 1em; width: 1px;">
                                    <!--div class="list-group-item" style="background-color: #b8b8b8;">Végeredmény</div-->
                                    <div class="list-group-item" style="width: 3em">1.</div>
                                    <div class="list-group-item" style="width: 3em">2.</div>
                                    <div class="list-group-item" style="width: 3em">3.</div>
                                    <div class="list-group-item" style="width: 3em">4.</div>
                                </div>

                                <div id="list-{{group.ID}}" class="list-group col" style="padding-left: 2em; width: 25em;">
                                    {% if group.bets|length > 0 %}
                                    {% for team in group.bets %}
                                        <div class="list-group-item" style="width: 20em;" data-id ="{{team.team}}">{{team.local_name}}</div>
                                    {% endfor %}
                                    {% else %}
                                    {% for team in group.teams %}
                                        <div class="list-group-item" style="width: 20em;" data-id ="{{team.name}}">{{team.local_name}}</div>
                                    {% endfor %}
                                    {% endif %}
                                </div>
                            </div> 

                            <label for="bet-{{group.ID}}" style="padding-left: 3em; padding-top: 1em;">Tét: </label>
                            <input type="number" size="3" value="{{group.bet_property.amount}}" id="bet-{{group.ID}}" name="bet-{{group.ID}}" min=0 max={{max_group_bet_value}} oninput="calculateRemainingBetAmount()">
                            <br>
                        {% endfor %}

                        <div>
                            <div style="display: inline-block;">Fennmaradő tőke: </div>
                            <div style="display: inline-block;" id="remainingAmount">0 tallér</div>
                        </div>

                        <div style="padding-left:1em; color:red;" id="errorMessage">
                            
                        </div>

                        <button type="button" id="sendButton"> Beküld</button> 
                        
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================================== -->
        <!-- End PAge Content -->
        <!-- ============================================================== -->
    </div>

{% endblock content %}

{% block javascripts %}
<script>
    var sortableArray = [];

    function populateSortableArray() {
        {% for group in groups %}
        sortableArray.push(["{{group.ID}}", new Sortable(document.getElementById('list-{{group.ID}}'), {
            animation: 150,
            ghostClass: 'blue-background-class'
        })]);
        {% endfor %}

        teamSelect.value = "{{final_bet.team}}";
        resultSelect.value = "{{final_bet.result}}";
    }
    
    function calculateRemainingBetAmount() {
        var remainingValue = {{start_amount}};

        for (const sortableElement of sortableArray) {
            let[groupID, group] = sortableElement;
            remainingValue -=  document.getElementById("bet-" + groupID).value;
        }

        remainingValue -= finalResultBet.value;
        remainingAmount.innerText = remainingValue + " tallér";
    }
</script>

<script type="module">
    var resultNamemap = {
        "0" : "Győztes",
        "1" : "Döntős",
        "2" : "Elődöntős",
        "3" : "Csoporkörön túl"
    }

    var scores = {
    {% for group in groups%}
        {% for team in group.teams %} "{{team.name}}" : [{{team.top1}}, {{team.top2}}, {{team.top4}}, {{team.top16}}],{% endfor %}
    {% endfor %}
    }

    var namemap = {
    {% for group in groups%}
        {% for team in group.teams %} "{{team.name}}" : "{{team.local_name}}",{% endfor %}
    {% endfor %}
    };

    var teamSelect = document.getElementById("teamSelect");
    var resultSelect = document.getElementById("resultSelect");
    var finalResultOdd = document.getElementById("finalResultOdd");
    var finalResultBet = document.getElementById("finalResultBet");
    var expectedWinAmount = document.getElementById("expectedWinAmount");

    for (const [key, value] of Object.entries(scores)) {
        //console.log(`${key}: ${value}`);
        teamSelect.options[teamSelect.options.length] = new Option(namemap[key], key);
    }

    for (let i = 0; i < 4; i++) {
        resultSelect.options[resultSelect.options.length] = new Option(resultNamemap[`${i}`], i);
    }

    function updateFinalBet() {
        var teamID = teamSelect.options[teamSelect.selectedIndex].value;
        var resultID = resultSelect.options[resultSelect.selectedIndex].value;

        var odd = scores[teamID][resultID];
        finalResultOdd.innerText = odd;
        finalResultOdd.value = odd;

        expectedWinAmount.value = Math.round(odd * finalResultBet.value * 100) / 100;

        calculateExpectedWinAmount();
    }

    function calculateExpectedWinAmount() {
        expectedWinAmount.value = Math.round(parseFloat(finalResultOdd.value) * finalResultBet.value * 100) / 100;
        expectedWinAmount.innerText = Math.round(parseFloat(finalResultOdd.value) * finalResultBet.value * 100) / 100;
    }

    teamSelect.onchange = updateFinalBet;
    resultSelect.onchange = updateFinalBet;

    finalResultBet.oninput = function() {
        if (this.value > {{max_final_bet_value}}) {
            this.value = {{max_final_bet_value}};
            this.innerText = {{max_final_bet_value}};
        }

        if (this.value < 0) {
            this.value = 0;
            this.innerText = 0;
        }

        calculateExpectedWinAmount();
        calculateRemainingBetAmount();
    }

    var sendButton = document.getElementById("sendButton");
    sendButton.onclick = function() {
        console.log( 'Sending data' );

        const XHR = new XMLHttpRequest();

        XHR.onload = function() {
            var responseObject = JSON.parse(XHR.response);
            
            if (responseObject["result"] == "OK") {
                window.location.href = "./?match_state=group";
            }
            else if (responseObject["result"] == "error") {
                var info = responseObject["info"];

                var errorMessage = "";

                switch(info) {
                    case "FINAL_TEAM":
                    errorMessage = "A végső tippnél megadott csapat nem létezik.";
                    break;

                    case "FINAL_RESULT":
                    errorMessage = "Hibás végsőtipp eredmény.";
                    break;

                    case "FINAL_BET":
                    errorMessage = "Hibás végsőtipp fogadási mennyiség.";
                    break;

                    case "GROUP_BET":
                    errorMessage = "Hibás fogadási mennyiség a csoportkörtippnél.";
                    break;

                    case "GROUP_ID":
                    errorMessage = "Hibás csoport azonosító.";
                    break;

                    case "GROUP_TEAM":
                    errorMessage = "Hibás csapatnév a csoportkörnél.";
                    console.log("GROUP_TEAM_ERROR");
                    break;
                }
                
                var errorMessageNode = document.getElementById("errorMessage");
                errorMessageNode.innerText = errorMessage;
            }
        }

        XHR.onerror = function() {
            alert('Hiba történt a szerverrel való kommunikációban.' );
        }

        // Set up our request
        XHR.open('POST', '/group', true);

        // Add the required HTTP header for form data POST requests
        //XHR.setRequestHeader( 'Content-Type', 'application/x-www-form-urlencoded' );
        XHR.setRequestHeader( 'Content-Type', 'application/json' );
        
        var output = {};

        var finalObject = {"team" : teamSelect.options[teamSelect.selectedIndex].value, "result" : resultSelect.options[resultSelect.selectedIndex].value, "bet" : document.getElementById("finalResultBet").value};
        output["final"] = finalObject;

        var groupsObject = {};

        for (const sortableElement of sortableArray) {
            let[groupID, group] = sortableElement;

            var groupObject = {}

            groupObject["bet"] = document.getElementById("bet-" + groupID).value;
            groupObject["order"] = group.toArray();

            groupsObject[groupID] = groupObject;
        }

        output["group"] = groupsObject;
         
        console.log("out: " + JSON.stringify(output));

        XHR.send(JSON.stringify(output));
    }

    var remainingAmount = document.getElementById("remainingAmount");

    window.onload = function() {
        populateSortableArray();
        updateFinalBet();
        calculateRemainingBetAmount();
    }

</script>          

{% endblock javascripts %}
